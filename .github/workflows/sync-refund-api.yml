name: Sync API Spec → Generate Collection → Link API

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest
    
    # Exit immediately if a command fails
    defaults:
      run:
        shell: bash -e {0}

    steps:
      - uses: actions/checkout@v3

      #######################################################################
      # 1. Read Spec File and Convert to Single-Line String
      #######################################################################
      - name: Load Spec File Into Variable
        id: loadspec
        run: |
          FILE=$(ls specs/payment-refund-api-openapi.*)
          # Use sed to escape quotes and escape newlines (required for inline JSON schema upload)
          CONTENTS=$(sed 's/"/\\"/g' "$FILE" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "contents=$CONTENTS" >> $GITHUB_OUTPUT
          echo "specfile=$FILE" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. Create API If Not Exists (FIXED with JSONAPI Payload)
      #######################################################################
      - name: Ensure API Exists (Attempting JSONAPI Payload Fix)
        id: ensureapi
        run: |
          API_NAME="Payment Refund API"
          WORKSPACE_ID="${{ secrets.POSTMAN_WORKSPACE_ID }}"
          echo "Searching for existing API: $API_NAME in workspace $WORKSPACE_ID"

          # API Lookup
          API_LOOKUP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.getpostman.com/apis?workspace=$WORKSPACE_ID")
          
          HTTP_STATUS=$(echo "$API_LOOKUP" | tail -n 1 | awk -F: '{print $2}')
          API_BODY=$(echo "$API_LOOKUP" | head -n -1)

          echo "--- RAW API LOOKUP RESPONSE (HTTP Status: $HTTP_STATUS) ---"
          echo "$API_BODY"
          echo "--------------------------------------------------------"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: Failed to lookup APIs (HTTP $HTTP_STATUS)."
            exit 1 
          fi

          API_ID=$(echo "$API_BODY" | jq -r \
            ".apis[] | select(.name==\"$API_NAME\") | .id")

          if [ -z "$API_ID" ] || [ "$API_ID" == "null" ]; then
            echo "API does not exist or jq failed to find it — creating…"
            
            # API Creation Call: 1. Workspace ID in URL. 2. Accept: v10. 3. JSONAPI body structure.
            CREATE_PAYLOAD='{"data":{"type":"api","attributes":{"name":"'${API_NAME}'"}}}'
            
            CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "https://api.getpostman.com/apis?workspace=$WORKSPACE_ID" \
              -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
              -H "Content-Type: application/json" \
              -H "Accept: application/vnd.api.v10+json" \
              -d "$CREATE_PAYLOAD") 
            
            HTTP_STATUS=$(echo "$CREATE" | tail -n 1 | awk -F: '{print $2}')
            CREATE_BODY=$(echo "$CREATE" | head -n -1)

            echo "--- RAW API CREATE RESPONSE (HTTP Status: $HTTP_STATUS) ---"
            echo "$CREATE_BODY"
            echo "----------------------------------------------------------"
            
            if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "201" ]; then
              echo "ERROR: Failed to create API (HTTP $HTTP_STATUS). Check body for details."
              exit 1
            fi
            
            # Try parsing v10 response structure (.data.id) first
            API_ID=$(echo "$CREATE_BODY" | jq -r ".data.id")
            
            if [ -z "$API_ID" ] || [ "$API_ID" == "null" ]; then
                # Fallback to older response structure (.api.id) if v10 parsing fails
                API_ID=$(echo "$CREATE_BODY" | jq -r ".api.id") 
                if [ -z "$API_ID" ] || [ "$API_ID" == "null" ]; then
                    echo "CRITICAL ERROR: Failed to parse API ID from creation response. Exiting."
                    exit 1
                fi
            fi

          else
            echo "API exists: $API_ID"
          fi

          echo "api_id=$API_ID" >> $GITHUB_OUTPUT
          echo "API_ID successfully exported: $API_ID"


      #######################################################################
      # 3. Ensure API Version Exists (with Debugging)
      #######################################################################
      - name: Ensure API Version Exists (with Debug)
        id: ensureversion
        run: |
          API_ID="${{ steps.ensureapi.outputs.api_id }}"
          VERSION_NAME="v1"
          
          echo "Looking up versions for API ID: $API_ID"

          VERSION_LOOKUP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.getpostman.com/apis/$API_ID/versions")
          
          HTTP_STATUS=$(echo "$VERSION_LOOKUP" | tail -n 1 | awk -F: '{print $2}')
          VERSION_BODY=$(echo "$VERSION_LOOKUP" | head -n -1)

          echo "--- RAW VERSION LOOKUP RESPONSE (HTTP Status: $HTTP_STATUS) ---"
          echo "$VERSION_BODY"
          echo "--------------------------------------------------------------"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: Failed to lookup API versions (HTTP $HTTP_STATUS)."
            exit 1 
          fi

          VERSION_ID=$(echo "$VERSION_BODY" | jq -r \
            ".versions[] | select(.name==\"$VERSION_NAME\") | .id")

          if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" == "null" ]; then
            echo "Version not found — creating v1…"
            CREATE_VERSION=$(curl -s -X POST \
              "https://api.getpostman.com/apis/$API_ID/versions" \
              -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$VERSION_NAME\"}")
            
            CREATE_VERSION_ID=$(echo "$CREATE_VERSION" | jq -r ".version.id")
            
            if [ -z "$CREATE_VERSION_ID" ] || [ "$CREATE_VERSION_ID" == "null" ]; then
                echo "CRITICAL ERROR: Failed to parse Version ID from creation response."
                exit 1
            fi

            VERSION_ID="$CREATE_VERSION_ID"
            echo "Created new Version ID: $VERSION_ID"
          fi

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "VERSION_ID successfully exported: $VERSION_ID"

      #######################################################################
      # 4. Create/Update SPEC (Schema)
      #######################################################################
      - name: Upload Spec to Postman Spec Hub
        id: uploadspec
        run: |
          API_ID="${{ steps.ensureapi.outputs.api_id }}"
          VERSION_ID="${{ steps.ensureversion.outputs.version_id }}"
          CONTENTS="${{ steps.loadspec.outputs.contents }}"

          echo "Attempting to upload spec to API $API_ID, Version $VERSION_ID..."

          # Create or update schema
          CREATE_SCHEMA=$(curl -s -X POST \
            "https://api.getpostman.com/apis/$API_ID/versions/$VERSION_ID/schemas" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"type\": \"openapi3\",
                  \"language\": \"yaml\",
                  \"schema\": \"$CONTENTS\"
                }")

          SCHEMA_ID=$(echo "$CREATE_SCHEMA" | jq -r ".schema.id")

          echo "Schema upload response: $CREATE_SCHEMA"
          echo "schema_id=$SCHEMA_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 5. Generate Collection from Spec
      #######################################################################
      - name: Generate Collection from Spec
        id: gencoll
        run: |
          SCHEMA_ID="${{ steps.uploadspec.outputs.schema_id }}"

          GEN=$(curl -s -X POST \
            "https://api.getpostman.com/apis/${{ steps.ensureapi.outputs.api_id }}/versions/${{ steps.ensureversion.outputs.version_id }}/schemas/$SCHEMA_ID/generate/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"workspace\": \"${{ secrets.POSTMAN_WORKSPACE_ID }}\", \"overwrite\": true}")

          COLLECTION_ID=$(echo "$GEN" | jq -r ".collectionId")

          echo "Collection generation response: $GEN"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 6. Attach JWT Pre-request Script
      #######################################################################
      - name: Inject JWT Script
        run: |
          COLLECTION_ID="${{ steps.gencoll.outputs.collection_id }}"

          curl -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"collection\": {
                    \"event\": [{
                      \"listen\": \"prerequest\",
                      \"script\": {
                        \"type\": \"text/javascript\",
                        \"exec\": [
                          \"const clientId = pm.environment.get('clientId');\",
                          \"const clientSecret = pm.environment.get('clientSecret');\",
                          \"const tokenUrl = pm.environment.get('tokenUrl');\",
                          \"pm.sendRequest({\",
                          \"  url: tokenUrl,\",
                          \"  method: 'POST',\",
                          \"  header: { 'Content-Type': 'application/x-www-form-urlencoded' },\",
                          \"  body: 'client_id=' + clientId + '&client_secret=' + clientSecret + '&grant_type=client_credentials'\",
                          \"}, function(err, res) { pm.environment.set('jwtToken', res.json().access_token); });\"
                        ]
                      }
                    }]
                  }
                }"

      #######################################################################
      # 7. (Optional) Run Tests Using Newman
      #######################################################################
      - name: Run Tests
        run: |
          npm install -g newman
          newman run "https://api.getpostman.com/collections/${{ steps.gencoll.outputs.collection_id }}?apikey=${{ secrets.POSTMAN_API_KEY }}"
