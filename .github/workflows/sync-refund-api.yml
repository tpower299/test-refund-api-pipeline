name: Sync API Spec → Generate Collection → Link API

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      #######################################################################
      # 1. Read Spec File and Convert to Single-Line String
      #######################################################################
      - name: Load Spec File Into Variable
        id: loadspec
        run: |
          FILE=$(ls specs/payment-refund-api-openapi.*)
          CONTENTS=$(sed 's/"/\\"/g' "$FILE" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "contents=$CONTENTS" >> $GITHUB_OUTPUT
          echo "specfile=$FILE" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. Create API If Not Exists
      #######################################################################
      - name: Ensure API Exists
        id: ensureapi
        run: |
          API_NAME="Payment Refund API"

          API_LOOKUP=$(curl -s -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.getpostman.com/apis?workspace=${{ secrets.POSTMAN_WORKSPACE_ID }}")

          API_ID=$(echo "$API_LOOKUP" | jq -r \
            ".apis[] | select(.name==\"$API_NAME\") | .id")

          if [ -z "$API_ID" ]; then
            echo "API does not exist — creating…"
            CREATE=$(curl -s -X POST \
              "https://api.getpostman.com/apis" \
              -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$API_NAME\", \"workspace\": \"${{ secrets.POSTMAN_WORKSPACE_ID }}\"}")
            API_ID=$(echo "$CREATE" | jq -r ".api.id")
          else
            echo "API exists: $API_ID"
          fi

          echo "api_id=$API_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 3. Ensure API Version Exists
      #######################################################################
      - name: Ensure API Version Exists
        id: ensureversion
        run: |
          API_ID="${{ steps.ensureapi.outputs.api_id }}"
          VERSION_NAME="v1"

          VERSION_LOOKUP=$(curl -s \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.getpostman.com/apis/$API_ID/versions")

          VERSION_ID=$(echo "$VERSION_LOOKUP" | jq -r \
            ".versions[] | select(.name==\"$VERSION_NAME\") | .id")

          if [ -z "$VERSION_ID" ]; then
            echo "Version not found — creating v1…"
            CREATE=$(curl -s -X POST \
              "https://api.getpostman.com/apis/$API_ID/versions" \
              -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$VERSION_NAME\"}")
            VERSION_ID=$(echo "$CREATE" | jq -r ".version.id")
          fi

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 4. Create/Update SPEC (Schema)
      #######################################################################
      - name: Upload Spec to Postman Spec Hub
        id: uploadspec
        run: |
          API_ID="${{ steps.ensureapi.outputs.api_id }}"
          VERSION_ID="${{ steps.ensureversion.outputs.version_id }}"
          CONTENTS="${{ steps.loadspe.outputs.contents }}"

          # Create or update schema
          CREATE_SCHEMA=$(curl -s -X POST \
            "https://api.getpostman.com/apis/$API_ID/versions/$VERSION_ID/schemas" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"type\": \"openapi3\",
                  \"language\": \"yaml\",
                  \"schema\": \"$CONTENTS\"
                }")

          SCHEMA_ID=$(echo "$CREATE_SCHEMA" | jq -r ".schema.id")

          echo "schema_id=$SCHEMA_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 5. Generate Collection from Spec
      #######################################################################
      - name: Generate Collection from Spec
        id: gencoll
        run: |
          SCHEMA_ID="${{ steps.uploadspec.outputs.schema_id }}"

          GEN=$(curl -s -X POST \
            "https://api.getpostman.com/apis/${{ steps.ensureapi.outputs.api_id }}/versions/${{ steps.ensureversion.outputs.version_id }}/schemas/$SCHEMA_ID/generate/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"workspace\": \"${{ secrets.POSTMAN_WORKSPACE_ID }}\", \"overwrite\": true}")

          COLLECTION_ID=$(echo "$GEN" | jq -r ".collectionId")

          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 6. Attach JWT Pre-request Script
      #######################################################################
      - name: Inject JWT Script
        run: |
          COLLECTION_ID="${{ steps.gencoll.outputs.collection_id }}"

          curl -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"collection\": {
                    \"event\": [{
                      \"listen\": \"prerequest\",
                      \"script\": {
                        \"type\": \"text/javascript\",
                        \"exec\": [
                          \"const clientId = pm.environment.get('clientId');\",
                          \"const clientSecret = pm.environment.get('clientSecret');\",
                          \"const tokenUrl = pm.environment.get('tokenUrl');\",
                          \"pm.sendRequest({\",
                          \"  url: tokenUrl,\",
                          \"  method: 'POST',\",
                          \"  header: { 'Content-Type': 'application/x-www-form-urlencoded' },\",
                          \"  body: 'client_id=' + clientId + '&client_secret=' + clientSecret + '&grant_type=client_credentials'\",
                          \"}, function(err, res) { pm.environment.set('jwtToken', res.json().access_token); });\"
                        ]
                      }
                    }]
                  }
                }"

      #######################################################################
      # 7. (Optional) Run Tests Using Newman
      #######################################################################
      - name: Run Tests
        run: |
          npm install -g newman
          newman run "https://api.getpostman.com/collections/${{ steps.gencoll.outputs.collection_id }}?apikey=${{ secrets.POSTMAN_API_KEY }}"

