name: Sync API Spec → Generate Collection from Spec Hub

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash -e {0}

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4 

      #######################################################################
      # 1. Detect spec file
      #######################################################################
      - name: Detect Spec File
        id: spec
        run: |
          # Finds the single spec file regardless of extension
          FILE=$(ls specs/payment-refund-api-openapi.*)
          echo "Found spec: $FILE"
          echo "specfile=$FILE" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. Sanitize encoding (prevent BOM / CR issues)
      #######################################################################
      - name: Sanitize Encoding
        run: |
          FILE="${{ steps.spec.outputs.specfile }}"
          iconv -c -f utf-8 -t utf-8 "$FILE" | tr -d '\r' > "$FILE.tmp"
          mv "$FILE.tmp" "$FILE"
          echo "Encoding sanitized."

      #######################################################################
      # 3. CREATE SPEC IN SPEC HUB (Final Fix)
      #######################################################################
      - name: Create Spec in Spec Hub
        id: create_spec
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          WORKSPACE_ID: 2bf1dd30-2897-4f0d-abf9-4a02d2970785
          FILE_PATH: ${{ steps.spec.outputs.specfile }}
        run: |
          echo "Constructing JSON payload with 'files' array structure..."
          
          # CRITICAL FIX: Use jq --rawfile and the structure provided by the professor.
          PAYLOAD=$(jq -n \
            --rawfile spec_content "$FILE_PATH" \
            '{
              name: "Payment Refund API",
              type: "openapi3",
              files: [
                {
                  path: "index.yaml",
                  content: $spec_content
                }
              ]
            }')

          echo "Sending payload to POST /specs..."
          
          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/specs?workspaceId=$WORKSPACE_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Spec creation response: $RESPONSE"

          SPEC_ID=$(echo "$RESPONSE" | jq -r '.spec.id')

          if [[ -z "$SPEC_ID" || "$SPEC_ID" == "null" ]]; then
            echo "CRITICAL ERROR: Failed to create spec. Check response above."
            exit 1
          fi

          echo "SUCCESS: Created Spec ID: $SPEC_ID"
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT 

      #######################################################################
      # 4. Generate collection from the spec
      #######################################################################
      - name: Generate Collection from Spec
        id: gen_collection
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          SPEC_ID: ${{ steps.create_spec.outputs.spec_id }}
        run: |
          echo "Generating collection from Spec ID $SPEC_ID…"

          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/specs/$SPEC_ID/generations/collection" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"options":{"requestParametersResolution":"example"}}')

          echo "Collection generation response: $RESPONSE"

          COLLECTION_ID=$(echo "$RESPONSE" | jq -r '.collection.id')

          if [[ -z "$COLLECTION_ID" || "$COLLECTION_ID" == "null" ]]; then
            echo "ERROR: Failed to extract COLLECTION_ID"
            exit 1
          fi

          echo "Generated Collection ID: $COLLECTION_ID"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 5. Inject JWT Pre-request Script
      #######################################################################
      - name: Inject JWT Script
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          COLLECTION_ID: ${{ steps.gen_collection.outputs.collection_id }}
        run: |
          echo "Injecting JWT prerequest script…"

          PAYLOAD=$(jq -n \
            '{"collection": {
              "event": [{
                "listen": "prerequest",
                "script": {
                  "type": "text/javascript",
                  "exec": [
                    "const clientId = pm.environment.get(\"clientId\");",
                    "const clientSecret = pm.environment.get(\"clientSecret\");",
                    "const tokenUrl = pm.environment.get(\"tokenUrl\");",
                    "",
                    "pm.sendRequest({",
                    "  url: tokenUrl,",
                    "  method: \"POST\",",
                    "  header: {\"Content-Type\": \"application/x-www-form-urlencoded\"},",
                    "  body: \"client_id=\" + clientId + \"&client_secret=\" + clientSecret + \"&grant_type=client_credentials\"",
                    "}, (err, res) => {",
                    "  if (!err) pm.environment.set(\"jwtToken\", res.json().access_token);",
                    "});"
                  ]
                }
              }]
            }}')

          RESPONSE=$(curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Collection update response: $RESPONSE"

      #######################################################################
      # 6. Run tests using Newman
      #######################################################################
      - name: Run Tests
        run: |
          npm install newman
          COLLECTION_ID="${{ steps.gen_collection.outputs.collection_id }}"

          echo "Running Newman tests…"
          npx newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=${{ secrets.POSTMAN_API_KEY }}"
