name: Sync API Spec â†’ Generate Collection using Spec Hub

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4

      #######################################################################
      # 1. Find spec file
      #######################################################################
      - name: Detect Spec File
        id: spec
        run: |
          FILE=$(ls specs/payment-refund-api-openapi.*)
          echo "specfile=$FILE" >> $GITHUB_OUTPUT
          echo "Found spec: $FILE"

      #######################################################################
      # 2. Sanitize encoding
      #######################################################################
      - name: Sanitize Encoding
        run: |
          FILE="${{ steps.spec.outputs.specfile }}"
          iconv -c -f utf-8 -t utf-8 "$FILE" | tr -d '\r' > "$FILE.tmp"
          mv "$FILE.tmp" "$FILE"

      #######################################################################
      # 3. CREATE SPEC (Spec Hub)
      #######################################################################
      - name: Create Spec in Spec Hub
        id: create_spec
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          WORKSPACE_ID: 2bf1dd30-2897-4f0d-abf9-4a02d2970785
          FILE_PATH: ${{ steps.spec.outputs.specfile }}
        run: |
          SPEC_CONTENT=$(cat "$FILE_PATH" | sed 's/"/\\"/g')

          PAYLOAD=$(jq -n \
            --arg name "Payment Refund API" \
            --arg content "$SPEC_CONTENT" \
            '{"spec": {"name": $name, "content": $content, "contentType": "yaml"}}')

          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/specs?workspaceId=$WORKSPACE_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Spec creation response: $RESPONSE"

          SPEC_ID=$(echo "$RESPONSE" | jq -r '.spec.id')

          if [[ -z "$SPEC_ID" || "$SPEC_ID" == "null" ]]; then
            echo "Failed to extract SPEC_ID"
            exit 1
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "Created Spec ID: $SPEC_ID"

      #######################################################################
      # 4. Generate a Collection from the Spec
      #######################################################################
      - name: Generate Collection from Spec
        id: gen
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          SPEC_ID: ${{ steps.create_spec.outputs.spec_id }}
        run: |
          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/specs/$SPEC_ID/generations/collection" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"options": {"requestParametersResolution": "example"}}')

          echo "Collection generation response: $RESPONSE"

          COLLECTION_ID=$(echo "$RESPONSE" | jq -r '.collection.id')

          if [[ -z "$COLLECTION_ID" || "$COLLECTION_ID" == "null" ]]; then
            echo "Failed to extract COLLECTION_ID"
            exit 1
          fi

          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT
          echo "Generated Collection ID: $COLLECTION_ID"

      #######################################################################
      # 5. Inject JWT pre-request script
      #######################################################################
      - name: Inject JWT Script
        env:
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          COLLECTION_ID: ${{ steps.gen.outputs.collection_id }}
        run: |
          PAYLOAD=$(jq -n \
            '{"collection": {"event": [{
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const clientId = pm.environment.get(\"clientId\");",
                  "const clientSecret = pm.environment.get(\"clientSecret\");",
                  "const tokenUrl = pm.environment.get(\"tokenUrl\");",
                  "",
                  "pm.sendRequest({",
                  "  url: tokenUrl,",
                  "  method: \"POST\",",
                  "  header: {\"Content-Type\": \"application/x-www-form-urlencoded\"},",
                  "  body: \"client_id=\" + clientId + \"&client_secret=\" + clientSecret + \"&grant_type=client_credentials\"",
                  "}, (err, res) => {",
                  "  if (!err) pm.environment.set(\"jwtToken\", res.json().access_token);",
                  "});"
                ]
              }
            }]}}')

          curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      #######################################################################
      # 6. Run tests via Newman
      #######################################################################
      - name: Run Tests
        run: |
          npm install newman
          COLLECTION_ID="${{ steps.gen.outputs.collection_id }}"
          npx newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=${{ secrets.POSTMAN_API_KEY }}"

