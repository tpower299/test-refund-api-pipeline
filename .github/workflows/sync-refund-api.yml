name: Sync API Specs and Run Tests with JWT

on:
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.json'

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout the repo
      - uses: actions/checkout@v3

      # 2️⃣ Retrieve latest spec
      - name: Retrieve API Spec
        run: |
          echo "Downloading latest spec..."
          curl -o specs/payment-refund-api-openapi.yaml \
            https://raw.githubusercontent.com/tpower299/postman-refund-api-ingestion/main/specs/payment-refund-api-openapi.yaml

      # 3️⃣ Update spec in Postman
      - name: Update Spec in Postman
        run: |
          curl -X PUT "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @specs/payment-refund-api-openapi.yaml

      # 4️⃣ Regenerate collection from spec
      - name: Regenerate Collection
        run: |
          curl -X POST "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}/generations/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"options": {"requestParametersResolution": "example"}}'

      # 5️⃣ Run collection tests for each environment with JWT
      - name: Run Collection Tests (Dev/QA/UAT/Prod)
        run: |
          COLLECTION_ID="${{ secrets.POSTMAN_COLLECTION_ID }}"
          for ENV in DEV QA UAT PROD
          do
            echo "Running collection against $ENV environment..."

            BASE_URL="${{ secrets['BASE_URL_'$ENV] }}"
            JWT_CLIENT_ID="${{ secrets.JWT_CLIENT_ID }}"
            JWT_CLIENT_SECRET="${{ secrets.JWT_CLIENT_SECRET }}"
            JWT_AUDIENCE="${{ secrets.JWT_AUDIENCE }}"
            JWT_TOKEN_URL="${{ secrets.JWT_TOKEN_URL }}"

            # Request JWT token from auth server
            JWT_TOKEN=$(curl -s -X POST "$JWT_TOKEN_URL" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "grant_type=client_credentials&client_id=$JWT_CLIENT_ID&client_secret=$JWT_CLIENT_SECRET&audience=$JWT_AUDIENCE" \
              | jq -r '.access_token')

            # Run collection with dynamic baseUrl and JWT
            curl -X POST "https://api.getpostman.com/collections/$COLLECTION_ID/run" \
              -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                    \"environment\": {
                      \"values\": [
                        {\"key\": \"baseUrl\", \"value\": \"$BASE_URL\", \"enabled\": true},
                        {\"key\": \"jwtToken\", \"value\": \"$JWT_TOKEN\", \"enabled\": true}
                      ]
                    }
                  }"
          done

