name: Sync API Spec → Generate Collection → Link API

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash -e {0}

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4

      #######################################################################
      # 1. Detect spec file (yaml/yml/json)
      #######################################################################
      - name: Load Spec File Path and Type
        id: loadspec
        run: |
          FILE=$(ls specs/payment-refund-api-openapi.*)

          if [[ "$FILE" =~ \.(yaml|yml)$ ]]; then
              LANG="yaml"
          elif [[ "$FILE" =~ \.json$ ]]; then
              LANG="json"
          else
              echo "Error: Unsupported file extension for $FILE"
              exit 1
          fi

          echo "Spec file found: $FILE"
          echo "specfile=$FILE" >> $GITHUB_OUTPUT

      #######################################################################
      # 1.5 SANITIZE ENCODING
      #######################################################################
      - name: Sanitize Spec File Encoding
        run: |
          FILE="${{ steps.loadspec.outputs.specfile }}"
          iconv -c -f utf-8 -t utf-8 "$FILE" | tr -d '\r' > "${FILE}.tmp"
          mv "${FILE}.tmp" "$FILE"
          echo "File encoding sanitized."

      #######################################################################
      # 2. CREATE API VERSION + IMPORT SPEC (Corrected!)
      #######################################################################
      - name: Publish Spec into Postman API Registry
        id: postman_import
        env:
          API_ID_FINAL: 4351c3b1-def3-4d95-9ef5-4ce0dcc42853
          API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          WORKSPACE_ID: 2bf1dd30-2897-4f0d-abf9-4a02d2970785
          FILE_PATH: ${{ steps.loadspec.outputs.specfile }}
          API_NAME: "Payment Refund API"
        run: |
          VERSION_NAME="v2.1.0-build-$(date +%Y%m%d%H%M%S)"
          VERSION_PAYLOAD_FILE="api_version_payload.json"

          echo "Using API ID: $API_ID_FINAL"

          ###################################################################
          # 2.1 Correct payload wrapper is: {"version": {"name": ... }}
          ###################################################################
          jq -n \
            --arg name "$VERSION_NAME" \
            '{"version": {"name": $name}}' > "$VERSION_PAYLOAD_FILE"

          echo "--- API VERSION PAYLOAD ---"
          cat "$VERSION_PAYLOAD_FILE"

          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/apis/$API_ID_FINAL/versions?workspaceId=$WORKSPACE_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Accept: application/vnd.api.v2+json" \
            -H "Content-Type: application/json" \
            --data @"$VERSION_PAYLOAD_FILE")

          echo "API Version Response: $RESPONSE"

          API_VERSION_ID=$(echo "$RESPONSE" | jq -r '.version.id')

          if [[ -z "$API_VERSION_ID" || "$API_VERSION_ID" == "null" ]]; then
            echo "CRITICAL ERROR: Failed to extract API Version ID"
            exit 1
          fi

          echo "Created API Version: $API_VERSION_ID"
          echo "api_version_id=$API_VERSION_ID" >> $GITHUB_OUTPUT

          ###################################################################
          # 2.2 UPLOAD SPEC → AUTOMATICALLY GENERATE LINKED COLLECTION
          ###################################################################
          echo "Uploading spec to new version..."

          RESPONSE=$(curl -s -X POST \
            "https://api.getpostman.com/apis/$API_ID_FINAL/versions/$API_VERSION_ID/schemas?workspaceId=$WORKSPACE_ID&modelType=collection" \
            -H "X-Api-Key: $API_KEY" \
            -F "type=openapi" \
            -F "input=file" \
            -F "spec=@$FILE_PATH")

          echo "Schema Import Response: $RESPONSE"

          COLLECTION_ID=$(echo "$RESPONSE" | jq -r '.collection.id')

          if [[ -z "$COLLECTION_ID" || "$COLLECTION_ID" == "null" ]]; then
            echo "CRITICAL ERROR: Could not extract Collection ID"
            exit 1
          fi

          echo "Linked Collection ID: $COLLECTION_ID"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 3. ADD JWT PRE-REQUEST SCRIPT TO COLLECTION
      #######################################################################
      - name: Inject JWT Script
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"
          API_KEY="${{ secrets.POSTMAN_API_KEY }}"

          echo "Injecting JWT script into collection $COLLECTION_ID"

          JWT_PAYLOAD=$(jq -n \
            '{"collection": {
              "event": [{
                "listen": "prerequest",
                "script": {
                  "type": "text/javascript",
                  "exec": [
                    "const clientId = pm.environment.get(\"clientId\");",
                    "const clientSecret = pm.environment.get(\"clientSecret\");",
                    "const tokenUrl = pm.environment.get(\"tokenUrl\");",
                    "",
                    "pm.sendRequest({",
                    "  url: tokenUrl,",
                    "  method: \"POST\",",
                    "  header: { \"Content-Type\": \"application/x-www-form-urlencoded\" },",
                    "  body: \"client_id=\" + clientId + \"&client_secret=\" + clientSecret + \"&grant_type=client_credentials\"",
                    "}, function(err, res) {",
                    "  if (!err) {",
                    "    pm.environment.set(\"jwtToken\", res.json().access_token);",
                    "  }",
                    "});"
                  ]
                }
              }]
            }}')

          curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JWT_PAYLOAD"

      #######################################################################
      # 4. OPTIONAL — Run generated tests via Newman
      #######################################################################
      - name: Run Tests
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"
          npm install newman
          echo "Running Newman tests on collection $COLLECTION_ID..."

          npx newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=${{ secrets.POSTMAN_API_KEY }}"

