name: Sync API Spec â†’ Generate Collection (Finalized Adoption Kit)

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"
  workflow_dispatch:

jobs:
  sync-api:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash -e {0}
        
    # --- IMPORTANT: Variables loaded from GitHub Secrets ---
    env:
      POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }} 
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
      - name: Install Dependencies
        run: |
          npm install -g openapi-to-postmanv2 newman
          sudo apt-get install -y jq # Ensure jq is available

      #######################################################################
      # 1. Detect and Sanitize Spec File
      #######################################################################
      - name: Detect and Sanitize Spec File
        id: spec
        run: |
          FILE=$(ls specs/payment-refund-api-openapi.*)
          iconv -c -f utf-8 -t utf-8 "$FILE" | tr -d '\r' > "$FILE.tmp"
          mv "$FILE.tmp" "$FILE"
          echo "specfile=$FILE" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. CREATE SPEC IN SPEC HUB (Conceptual Proof) - DEBUG ADDED
      #######################################################################
      - name: Create Spec in Spec Hub (Conceptual Proof)
        id: create_spec
        run: |
          echo "DEBUG: API Key starting with: ${POSTMAN_API_KEY:0:5}..."
          echo "DEBUG: Workspace ID being used: $POSTMAN_WORKSPACE_ID" 
          
          PAYLOAD=$(jq -n \
            --rawfile spec_content "${{ steps.spec.outputs.specfile }}" \
            '{ name: "Payment Refund API", type: "OPENAPI:3.0", files: [{ path: "index.yaml", content: $spec_content }] }')
            
          RESPONSE=$(curl -w "%{http_code}" -X POST \
            "https://api.getpostman.com/specs?workspaceId=$POSTMAN_WORKSPACE_ID" \
            -H "X-Api-Key: $POSTMAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" | tail -n 1)

          STATUS_CODE=$(echo $RESPONSE | tail -c 4)
          
          if [[ "$STATUS_CODE" != "200" ]]; then
              echo "WARNING: Spec Hub upload failed with status $STATUS_CODE. Ignoring for primary mission."
              echo "RAW RESPONSE: $RESPONSE"
          else
              echo "SUCCESS: Spec entity created/updated in Spec Hub."
          fi

      #######################################################################
      # 3. GENERATE COLLECTION LOCALLY
      #######################################################################
      - name: Generate Collection Locally
        id: local_gen
        run: |
          npx openapi-to-postmanv2 \
            -s ${{ steps.spec.outputs.specfile }} \
            -o collection.json
          echo "SUCCESS: Collection JSON generated locally."

      #######################################################################
      # 4. UPLOAD/UPDATE COLLECTION (Initial Upload) - HYPER-VIGILANT DEBUG
      #######################################################################
      - name: Upload or Update Collection (Initial Upload)
        id: upload_collection
        run: |
          echo "Uploading to Workspace ID: $POSTMAN_WORKSPACE_ID" 
          
          PAYLOAD=$(jq -n \
            --rawfile collection_content collection.json \
            '{collection: ($collection_content | fromjson)}' )
            
          RESPONSE=$(curl -w "%{http_code}" -X POST \
            "https://api.getpostman.com/collections?workspaceId=$POSTMAN_WORKSPACE_ID" \
            -H "X-Api-Key: $POSTMAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" | tail -n 1)
                      
          STATUS_CODE=$(echo $RESPONSE | tail -c 4)
          COLLECTION_ID=$(echo "$RESPONSE" | jq -r '.collection.id')

          if [[ "$STATUS_CODE" != "200" || -z "$COLLECTION_ID" || "$COLLECTION_ID" == "null" ]]; then
            echo "CRITICAL ERROR: Failed to upload collection."
            echo "HTTP STATUS: $STATUS_CODE (Should be 200)"
            echo "RAW RESPONSE: $RESPONSE"
            exit 1
          fi
          echo "SUCCESS: Collection uploaded. ID: $COLLECTION_ID"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 5. Inject JWT Pre-request Script (Fetch-Modify-Put Pattern)
      #######################################################################
      - name: Inject Advanced JWT Script
        run: |
          COLLECTION_ID="${{ steps.upload_collection.outputs.collection_id }}"
          API_KEY="$POSTMAN_API_KEY"

          # 5a. Fetch Collection
          FULL_COLLECTION_RESPONSE=$(curl -s -X GET "https://api.getpostman.com/collections/$COLLECTION_ID" -H "X-Api-Key: $API_KEY")
          
          if echo "$FULL_COLLECTION_RESPONSE" | jq -e '.collection' > /dev/null; then
              FULL_COLLECTION=$(echo "$FULL_COLLECTION_RESPONSE" | jq '.collection')
          else
              echo "CRITICAL ERROR: Failed to fetch collection for modification (The collection exists, but we can't retrieve it. Check API Key permissions!)."
              exit 1
          fi
          
          # 5b. Define and Modify (Advanced JWT Script)
          JWT_SCRIPT='[ { "listen": "prerequest", "script": { "type": "text/javascript", "exec": [ "// Advanced JWT Auth: Checks expiry and refreshes token", "const clientId = pm.environment.get(\"clientId\");", "const clientSecret = pm.environment.get(\"clientSecret\");", "const tokenUrl = pm.environment.get(\"tokenUrl\");", "const cachedToken = pm.environment.get(\"jwtToken\");", "const tokenExpiry = parseInt(pm.environment.get(\"tokenExpiry\"));", "", "// Check if token is valid (exists AND expiry time is > 30s in the future)", "if (cachedToken && tokenExpiry && Date.now() < (tokenExpiry - 30000)) {", "    pm.request.headers.upsert({key: \"Authorization\", value: \"Bearer \" + cachedToken});", "    return; // Skip token request", "}", "", "// Request new token", "pm.sendRequest({", "    url: tokenUrl,", "    method: \"POST\",", "    header: {\"Content-Type\": \"application/x-www-form-urlencoded\"},", "    body: {mode: \"urlencoded\", urlencoded: [{key: \"grant_type\", value: \"client_credentials\"}, {key: \"client_id\", value: clientId}, {key: \"client_secret\", value: clientSecret}]} ", "}, (err, response) => {", "    if (err || response.code !== 200) {", "        console.error(\"Token request failed:\", err || response.status);", "        return;", "    }", "    const jsonData = response.json();", "    const token = jsonData.access_token;", "    const expires_in_ms = jsonData.expires_in * 1000; ", "    pm.environment.set(\"jwtToken\", token);", "    pm.environment.set(\"tokenExpiry\", Date.now() + expires_in_ms);", "    pm.request.headers.upsert({key: \"Authorization\", value: \"Bearer \" + token});", "});" ] } } ]'
                      
          MODIFIED_PAYLOAD=$(echo "$FULL_COLLECTION" | jq --argjson script_event "$JWT_SCRIPT" '. + {event: $script_event}')
                    
          # 5c. Push Update (PUT)
          curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"collection\": $MODIFIED_PAYLOAD}" > /dev/null
          
          echo "SUCCESS: Collection updated with advanced JWT script."
          
      #######################################################################
      # 6. CREATE DEV ENVIRONMENT (Required Component) - DEBUG ADDED
      #######################################################################
      - name: Create Base Dev Environment
        id: create_env
        run: |
          ENV_PAYLOAD='{
            "environment": {
              "name": "Payment Processing - Dev",
              "values": [
                { "key": "baseUrl", "value": "https://dev.api.paymentco.com/v1", "enabled": true },
                { "key": "tokenUrl", "value": "https://auth.internal.com/token", "enabled": true },
                { "key": "clientId", "value": "dev-client-id-internal", "enabled": true },
                { "key": "clientSecret", "value": "dev-secret-internal", "enabled": true },
                { "key": "jwtToken", "value": "", "enabled": true },
                { "key": "tokenExpiry", "value": "0", "enabled": true }
              ]
            }
          }'

          RESPONSE=$(curl -w "%{http_code}" -X POST \
            "https://api.getpostman.com/environments?workspaceId=$POSTMAN_WORKSPACE_ID" \
            -H "X-Api-Key: $POSTMAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$ENV_PAYLOAD" | tail -n 1)

          STATUS_CODE=$(echo $RESPONSE | tail -c 4)
          ENV_ID=$(echo "$RESPONSE" | jq -r '.environment.id')
          
          if [[ "$STATUS_CODE" != "200" || -z "$ENV_ID" || "$ENV_ID" == "null" ]]; then
            echo "CRITICAL WARNING: Environment creation failed."
            echo "HTTP STATUS: $STATUS_CODE (Should be 200)"
            echo "RAW RESPONSE: $RESPONSE"
          else
            echo "SUCCESS: Dev Environment created. ID: $ENV_ID"
          fi
          
      #######################################################################
      # 7. Run tests using Newman (Final CI/CD Check)
      #######################################################################
      - name: Run Tests (Newman Validation)
        run: |
          COLLECTION_ID="${{ steps.upload_collection.outputs.collection_id }}"
          echo "Running Newman tests to validate the synchronized collection (CI/CD)..."
          
          npx newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=$POSTMAN_API_KEY" \
            --insecure \
            --env-var "baseUrl=https://mock-payment-api.com/dev" \
            --env-var "tokenUrl=https://mock-auth.internal.com/token" \
            --env-var "clientId=mock_client" \
            --env-var "clientSecret=mock_secret"
            
          echo "Newman run complete. All required steps for the Adoption Starter Kit are demonstrated."
