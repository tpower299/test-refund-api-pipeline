name: Sync API Specs to Postman

on:
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.json'

jobs:
  sync-specs:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repo
      - uses: actions/checkout@v3

      # Step 2: Install Node (needed for Postman CLI)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'  # Ensure a Node version compatible with Postman CLI

      # Step 3: Install Postman CLI
      - name: Install Postman CLI
        run: npm install -g postman-cli

      # Step 4: Login to Postman CLI using API key
      - name: Login to Postman CLI
        run: |
          echo "$POSTMAN_API_KEY" > ~/.postman_apikey
          postman login
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}

      # Step 5: Update Spec in Postman
      - name: Update Spec in Postman
        run: |
          SPEC_ID="${{ secrets.POSTMAN_SPEC_ID }}"
          curl -X PUT "https://api.getpostman.com/specs/$SPEC_ID" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @specs/payment-refund-api-openapi.yaml
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}

      # Step 6: Regenerate Collection from Spec
      - name: Regenerate Collection
        run: |
          SPEC_ID="${{ secrets.POSTMAN_SPEC_ID }}"
          curl -X POST "https://api.getpostman.com/specs/$SPEC_ID/generations/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"options": {"requestParametersResolution": "example"}}'
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}

      # Step 7: Run Collection (with optional environment)
      - name: Run Collection
        run: |
          COLLECTION_ID="${{ secrets.POSTMAN_COLLECTION_ID }}"
          ENV_ID="${{ secrets.POSTMAN_ENVIRONMENT_ID }}" # Optional, can be empty
          if [ -z "$ENV_ID" ]; then
            npx postman-cli collection run $COLLECTION_ID
          else
            npx postman-cli collection run $COLLECTION_ID --environment $ENV_ID
          fi
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
