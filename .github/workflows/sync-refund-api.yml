name: Sync API Spec → Generate Collection → Link API

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest
    
    # Exit immediately if a command fails
    defaults:
      run:
        shell: bash -e {0}

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4 # Ensure Node.js is available for the Postman CLI

      #######################################################################
      # 1. Read Spec File and Get File Path
      #######################################################################
      - name: Load Spec File Path and Type
        id: loadspec
        run: |
          # Finds the single spec file regardless of extension
          FILE=$(ls specs/payment-refund-api-openapi.*)
          
          if [[ "$FILE" =~ \.(yaml|yml)$ ]]; then
              LANG="yaml"
          elif [[ "$FILE" =~ \.json$ ]]; then
              LANG="json"
          else
              echo "Error: Unsupported file extension for $FILE"
              exit 1
          fi

          echo "Spec file found: $FILE"
          echo "specfile=$FILE" >> $GITHUB_OUTPUT
          echo "file_type=$LANG" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. IMPORT SPEC and GENERATE COLLECTION via POSTMAN CLI (COMMAND FIX)
      #######################################################################
      - name: Install and Import Spec via Postman CLI
        id: postman_import
        run: |
          # Use sudo for global npm install to fix EACCES permission denied error.
          sudo npm install -g postman-cli

          API_NAME="Payment Refund API"
          WORKSPACE_ID="2bf1dd30-2897-4f0d-abf9-4a02d2970785" 
          FILE="${{ steps.loadspec.outputs.specfile }}"
          API_KEY="${{ secrets.POSTMAN_API_KEY }}"

          echo "Importing spec file ($FILE) for API: $API_NAME to Spec Hub via Postman CLI..."

          # CRITICAL FIX: Changing from 'postman api import' to the supported 'postman import'.
          # We rely on environment variables for the API key for clean execution.
          OUTPUT=$(POSTMAN_API_KEY="$API_KEY" npx postman import "$FILE" \
            --workspace-id $WORKSPACE_ID \
            --name "$API_NAME") 

          echo "--- POSTMAN CLI RAW OUTPUT ---"
          echo "$OUTPUT"
          echo "------------------------------"
          

          # The 'postman import' command typically creates a Collection and may not directly link to an API/Spec.
          # We are parsing for the Collection ID which is the most critical piece of output.
          COLLECTION_ID=$(echo "$OUTPUT" | jq -r '
            .collection.id
          ')

          if [ -z "$COLLECTION_ID" ] || [ "$COLLECTION_ID" == "null" ]; then
             echo "CRITICAL ERROR: Failed to find generated COLLECTION ID in Postman CLI output. Check CLI output for errors."
             exit 1
          fi
          
          echo "Collection ID generated by CLI: $COLLECTION_ID"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT
          # Note: We skip the spec_id for now as 'postman import' focuses on collections, 
          # but the collection is what is needed for the remaining steps.

      #######################################################################
      # 3. Attach JWT Pre-request Script (Collection Update)
      #######################################################################
      - name: Inject JWT Script
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"

          echo "Injecting JWT pre-request script into collection $COLLECTION_ID"
          
          # This CURL command remains necessary for modifying collection scripts.
          curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"collection\": {
                    \"event\": [{
                      \"listen\": \"prerequest\",
                      \"script\": {
                        \"type\": \"text/javascript\",
                        \"exec\": [
                          \"// JWT Auth Script: Use pm.environment.get() for client/token details\",
                          \"const clientId = pm.environment.get('clientId');\",
                          \"const clientSecret = pm.environment.get('clientSecret');\",
                          \"const tokenUrl = pm.environment.get('tokenUrl');\",
                          \"pm.sendRequest({\",
                          \"  url: tokenUrl,\",
                          \"  method: 'POST',\",
                          \"  header: { 'Content-Type': 'application/x-www-form-urlencoded' },\",
                          \"  body: 'client_id=' + clientId + '&client_secret=' + clientSecret + '&grant_type=client_credentials'\",
                          \"}, function(err, res) { pm.environment.set('jwtToken', res.json().access_token); });\"
                        ]
                      }
                    }]
                  }
                }"

      #######################################################################
      # 4. (Optional) Run Tests Using Newman
      #######################################################################
      - name: Run Tests
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"

          npm install -g newman
          echo "Running Newman tests on generated collection $COLLECTION_ID..."
          
          newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=${{ secrets.POSTMAN_API_KEY }}"
