name: Sync API Spec → Generate Collection → Link API

on:
  push:
    paths:
      - "specs/**/*.yaml"
      - "specs/**/*.yml"
      - "specs/**/*.json"

jobs:
  sync-api:
    runs-on: ubuntu-latest
    
    # Exit immediately if a command fails
    defaults:
      run:
        shell: bash -e {0}

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4 # Ensure Node.js is available for the Postman CLI

      #######################################################################
      # 1. Read Spec File and Get File Path (Simplified for CLI)
      #######################################################################
      - name: Load Spec File Path and Type
        id: loadspec
        run: |
          # Finds the single spec file regardless of extension
          FILE=$(ls specs/payment-refund-api-openapi.*)
          
          if [[ "$FILE" =~ \.(yaml|yml)$ ]]; then
              LANG="yaml"
          elif [[ "$FILE" =~ \.json$ ]]; then
              LANG="json"
          else
              echo "Error: Unsupported file extension for $FILE"
              exit 1
          fi

          echo "Spec file found: $FILE"
          echo "specfile=$FILE" >> $GITHUB_OUTPUT
          echo "file_type=$LANG" >> $GITHUB_OUTPUT

      #######################################################################
      # 2. IMPORT SPEC and GENERATE COLLECTION via POSTMAN CLI
      # This replaces the failed curl steps 2 and 3.
      #######################################################################
      - name: Install and Import Spec via Postman CLI
        id: postman_import
        run: |
          # Install the Postman CLI tool globally
          npm install -g postman-cli

          API_NAME="Payment Refund API"
          WORKSPACE_ID="2bf1dd30-2897-4f0d-abf9-4a02d2970785" 
          FILE="${{ steps.loadspec.outputs.specfile }}"

          echo "Importing spec file ($FILE) for API: $API_NAME to Spec Hub via Postman CLI..."

          # The Postman CLI handles the API call, encoding, and collection generation internally.
          OUTPUT=$(postman api import "$FILE" \
            --workspace $WORKSPACE_ID \
            --api-key ${{ secrets.POSTMAN_API_KEY }} \
            --format yaml) 

          echo "--- POSTMAN CLI RAW OUTPUT ---"
          echo "$OUTPUT"
          echo "------------------------------"

          # Use jq to safely parse the required IDs from the complex CLI output structure.
          # The CLI is expected to create an API, a Version, and a linked Collection.
          
          # 1. Get the Collection ID created by the import process
          COLLECTION_ID=$(echo "$OUTPUT" | jq -r '
            .api.versions[0].collections[] | select(.type=="collection") | .id
          ')
          
          # 2. Get the Spec ID created by the import process
          SPEC_ID=$(echo "$OUTPUT" | jq -r '.api.versions[0].specs[] | .id')

          if [ -z "$COLLECTION_ID" ] || [ "$COLLECTION_ID" == "null" ]; then
             echo "CRITICAL ERROR: Failed to find generated COLLECTION ID in Postman CLI output."
             exit 1
          fi
          
          if [ -z "$SPEC_ID" ] || [ "$SPEC_ID" == "null" ]; then
             echo "CRITICAL ERROR: Failed to find created SPEC ID in Postman CLI output."
             exit 1
          fi

          echo "Spec ID created: $SPEC_ID"
          echo "Collection ID generated by CLI: $COLLECTION_ID"
          echo "collection_id=$COLLECTION_ID" >> $GITHUB_OUTPUT
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT

      #######################################################################
      # 3. Attach JWT Pre-request Script (Collection Update)
      #######################################################################
      - name: Inject JWT Script
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"

          echo "Injecting JWT pre-request script into collection $COLLECTION_ID"
          
          # This CURL command remains necessary as the Postman CLI does not offer 
          # a command for modifying collection events/scripts directly.
          curl -s -X PUT \
            "https://api.getpostman.com/collections/$COLLECTION_ID" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"collection\": {
                    \"event\": [{
                      \"listen\": \"prerequest\",
                      \"script\": {
                        \"type\": \"text/javascript\",
                        \"exec\": [
                          \"// JWT Auth Script: Use pm.environment.get() for client/token details\",
                          \"const clientId = pm.environment.get('clientId');\",
                          \"const clientSecret = pm.environment.get('clientSecret');\",
                          \"const tokenUrl = pm.environment.get('tokenUrl');\",
                          \"pm.sendRequest({\",
                          \"  url: tokenUrl,\",
                          \"  method: 'POST',\",
                          \"  header: { 'Content-Type': 'application/x-www-form-urlencoded' },\",
                          \"  body: 'client_id=' + clientId + '&client_secret=' + clientSecret + '&grant_type=client_credentials'\",
                          \"}, function(err, res) { pm.environment.set('jwtToken', res.json().access_token); });\"
                        ]
                      }
                    }]
                  }
                }"

      #######################################################################
      # 4. (Optional) Run Tests Using Newman
      #######################################################################
      - name: Run Tests
        run: |
          COLLECTION_ID="${{ steps.postman_import.outputs.collection_id }}"

          npm install -g newman
          echo "Running Newman tests on generated collection $COLLECTION_ID..."
          
          newman run "https://api.getpostman.com/collections/$COLLECTION_ID?apikey=${{ secrets.POSTMAN_API_KEY }}"
