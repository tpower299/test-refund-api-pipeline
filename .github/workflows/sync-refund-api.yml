name: Sync API Specs and Run Tests

on:
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.json'

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [DEV, QA, UAT, PROD]

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Install yq (YAML → JSON conversion)
      - name: Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq jq curl

      # 3. Set environment variables based on matrix
      - name: Set Environment Variables
        run: |
          if [ "${{ matrix.env }}" = "DEV" ]; then
            BASE_URL="${{ secrets.BASE_URL_DEV }}"
            JWT_CLIENT_ID="${{ secrets.JWT_CLIENT_ID_DEV }}"
            JWT_CLIENT_SECRET="${{ secrets.JWT_CLIENT_SECRET_DEV }}"
            JWT_TOKEN_URL="${{ secrets.JWT_TOKEN_URL_DEV }}"
            JWT_AUDIENCE="${{ secrets.JWT_AUDIENCE_DEV }}"
          elif [ "${{ matrix.env }}" = "QA" ]; then
            BASE_URL="${{ secrets.BASE_URL_QA }}"
            JWT_CLIENT_ID="${{ secrets.JWT_CLIENT_ID_QA }}"
            JWT_CLIENT_SECRET="${{ secrets.JWT_CLIENT_SECRET_QA }}"
            JWT_TOKEN_URL="${{ secrets.JWT_TOKEN_URL_QA }}"
            JWT_AUDIENCE="${{ secrets.JWT_AUDIENCE_QA }}"
          elif [ "${{ matrix.env }}" = "UAT" ]; then
            BASE_URL="${{ secrets.BASE_URL_UAT }}"
            JWT_CLIENT_ID="${{ secrets.JWT_CLIENT_ID_UAT }}"
            JWT_CLIENT_SECRET="${{ secrets.JWT_CLIENT_SECRET_UAT }}"
            JWT_TOKEN_URL="${{ secrets.JWT_TOKEN_URL_UAT }}"
            JWT_AUDIENCE="${{ secrets.JWT_AUDIENCE_UAT }}"
          elif [ "${{ matrix.env }}" = "PROD" ]; then
            BASE_URL="${{ secrets.BASE_URL_PROD }}"
            JWT_CLIENT_ID="${{ secrets.JWT_CLIENT_ID_PROD }}"
            JWT_CLIENT_SECRET="${{ secrets.JWT_CLIENT_SECRET_PROD }}"
            JWT_TOKEN_URL="${{ secrets.JWT_TOKEN_URL_PROD }}"
            JWT_AUDIENCE="${{ secrets.JWT_AUDIENCE_PROD }}"
          fi

          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "JWT_CLIENT_ID=$JWT_CLIENT_ID" >> $GITHUB_ENV
          echo "JWT_CLIENT_SECRET=$JWT_CLIENT_SECRET" >> $GITHUB_ENV
          echo "JWT_TOKEN_URL=$JWT_TOKEN_URL" >> $GITHUB_ENV
          echo "JWT_AUDIENCE=$JWT_AUDIENCE" >> $GITHUB_ENV
          echo "ENV=${{ matrix.env }}" >> $GITHUB_ENV

      # 4. Process each spec
      - name: Process API Specs
        run: |
          POSTMAN_API_KEY="${{ secrets.POSTMAN_API_KEY }}"
          WORKSPACE_ID="${{ secrets.POSTMAN_WORKSPACE_ID }}"

          echo "Workspace ID: $WORKSPACE_ID"
          echo "Postman API Key length: ${#POSTMAN_API_KEY}"

          for SPEC_FILE in specs/*.{yaml,json}; do
            [ -f "$SPEC_FILE" ] || continue

            SPEC_NAME=$(basename "$SPEC_FILE" | sed 's/\.[^.]*$//')
            echo "Processing spec: $SPEC_NAME ($SPEC_FILE)"

# Convert YAML to JSON safely using yq
if [[ "$SPEC_FILE" == *.yaml ]]; then
  # yq v4 syntax
  SPEC_CONTENT=$(yq eval -o=json "$SPEC_FILE")
else
  SPEC_CONTENT=$(cat "$SPEC_FILE")
fi
            # Check if the spec exists (safe iteration)
            EXISTING_SPEC_ID=$(curl -s -H "X-Api-Key: $POSTMAN_API_KEY" \
              "https://api.getpostman.com/specs?workspaceId=$WORKSPACE_ID" \
              | jq -r --arg NAME "$SPEC_NAME" '.specs // [] | .[] | select(.name==$NAME) | .id')

            if [ -z "$EXISTING_SPEC_ID" ]; then
              echo "Spec not found — creating new spec..."
              RESPONSE=$(curl -s -w "%{http_code}" -o response.json -X POST "https://api.getpostman.com/specs" \
                -H "X-Api-Key: $POSTMAN_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{
                      \"spec\": {
                        \"name\": \"$SPEC_NAME\",
                        \"type\": \"openapi3\",
                        \"content\": $SPEC_CONTENT
                      },
                      \"workspace\": {
                        \"id\": \"$WORKSPACE_ID\"
                      }
                    }")
            else
              echo "Spec exists — updating spec $EXISTING_SPEC_ID..."
              RESPONSE=$(curl -s -w "%{http_code}" -o response.json -X PUT "https://api.getpostman.com/specs/$EXISTING_SPEC_ID" \
                -H "X-Api-Key: $POSTMAN_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{
                      \"spec\": {
                        \"name\": \"$SPEC_NAME\",
                        \"type\": \"openapi3\",
                        \"content\": $SPEC_CONTENT
                      }
                    }")
            fi

            STATUS=$(tail -n1 <<< "$RESPONSE")
            if [ "$STATUS" -ge 400 ]; then
              echo "Error creating/updating spec:"
              cat response.json
              exit 1
            fi

            # Fetch Spec ID again (in case newly created)
            SPEC_ID=$(curl -s -H "X-Api-Key: $POSTMAN_API_KEY" \
                        "https://api.getpostman.com/specs?workspaceId=$WORKSPACE_ID" \
                        | jq -r --arg NAME "$SPEC_NAME" '.specs // [] | .[] | select(.name==$NAME) | .id')

            if [ -z "$SPEC_ID" ]; then
              echo "Spec ID not found after creation — skipping collection generation."
              continue
            fi

            # Generate collection from spec
            echo "Regenerating collection from spec $SPEC_ID..."
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json -X POST "https://api.getpostman.com/specs/$SPEC_ID/generations/collection" \
              -H "X-Api-Key: $POSTMAN_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"options": {"overwrite": true, "requestParametersResolution": "example"}}')

            STATUS=$(tail -n1 <<< "$RESPONSE")
            if [ "$STATUS" -ge 400 ]; then
              echo "Error generating collection:"
              cat response.json
              continue
            fi

            # Inject JWT pre-request script
            COLLECTION_ID=$(curl -s -H "X-Api-Key: $POSTMAN_API_KEY" \
              "https://api.getpostman.com/collections?workspace=$WORKSPACE_ID" \
              | jq -r --arg NAME "$SPEC_NAME" '.collections // [] | .[] | select(.name==$NAME) | .uid')

            if [ -z "$COLLECTION_ID" ]; then
              echo "Collection ID not found — skipping JWT injection."
              continue
            fi

            echo "Injecting JWT pre-request script into collection $COLLECTION_ID..."
            curl -s -X PUT "https://api.getpostman.com/collections/$COLLECTION_ID" \
              -H "X-Api-Key: $POSTMAN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                    \"event\": [
                      {
                        \"listen\": \"prerequest\",
                        \"script\": {
                          \"type\": \"text/javascript\",
                          \"exec\": [
                            \"const clientId = '$JWT_CLIENT_ID';\",
                            \"const clientSecret = '$JWT_CLIENT_SECRET';\",
                            \"const tokenUrl = '$JWT_TOKEN_URL';\",
                            \"const audience = '$JWT_AUDIENCE';\",
                            \"const options = { method: 'POST', url: tokenUrl, header: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'client_id=' + clientId + '&client_secret=' + clientSecret + '&audience=' + audience + '&grant_type=client_credentials' };\",
                            \"pm.sendRequest(options, function (err, res) { pm.environment.set('jwtToken', res.json().access_token); });\"
                          ]
                        }
                      }
                    ]
                  }"
          done

